Проверьте, пожалуйста, основную часть работы. Я постараюсь до ночи исправить косяк с бесконечным циклом. Нашёл причину. Думаю над устранением