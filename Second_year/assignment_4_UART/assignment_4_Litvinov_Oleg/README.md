
# Задание 4 - UART
# Срок сдачи: 20 мая 2018 года, 01:00

**Attention: в этом задании нужно писать отчет! В свободной форме, но указывая фамилию и номер группы!**

# Задание

Задание из двух частей, для каждой части предусмотрен отдельный проект - part_1 и part_2 соответственно. Очень прошу вас воспользоваться ими.

В обоих частях задания настройки UART должны быть следующими:
- без проверки четности
- 1 стоп-бит
- 8 бит данных
- без управления потоком

Если вы по какой-то причине решили подключать UART, кнопки, светодиоды или динамики не так, как предписано по заданию, пишите это огромными буквами в отчете, в комментарии к пулл-реквесту или в первых строках main.c!

## Часть первая

Два микроконтроллера (МК1 и МК2) соединены с помощью интерфейса UART. К каждому микроконтроллеру подключена кнопка и светодиод.  
Когда на МК1 нажата кнопка - загорается светодиод на МК2.   
Когда на МК2 нажата кнопка - загорается светодиод на МК1.  
Когда соответствующая кнопка не нажата - соответствующий светодиод не горит.

Не трудно видеть, что программы в обоих МК одинаковые.

Кнопка подключена на РА0 (высокий уровень означает, что кнопка нажата; подтягивающий резистор уже есть на плате), светодиод подключен к РС8.

Используется UART1 на выводах РА9 и РА10.


**Обязательно** опишите в отчете протокол обмена данными (т.е. что микроконтроллеры посылают по UART'у, когда кнопка нажата или не нажата). Бодрейт вы выбираете самостоятельно, но, пожалуйста, **указывайте** его в отчете.

## Часть вторая:

К микроконтроллеру подключен динамик.
Микроконтроллеру по интерфейсу UART приходит сообщение-запрос, в котором указывается частота звука. Как только микроконтроллер принимает правильное сообщение, он должен генерировать звук соответствующей частоты.  
На каждое правильное сообщение микроконтроллер должен отправить ответ.  
Правильное сообщение-запрос имеет длину пять байт и выглядит следующим образом:

| 1 байт | 2 байт | 3 байт   | 4 байт    | 5 байт   |
| ------ | ------ | -------- | --------- | -------- |
| 0xBB   | 0xCC   | freq low | freq high | checksum |

здесь: 
- первые два байта - это неизменный заголовок;
- freq low и freq high – это двухбайтное беззнаковое число – частота звука в Герцах, freq low - это младший байт, freq high - старший;
- checksum - контрольная сумма, которая вычисляется как остаток от деления суммы предыдущих байт на 256.

Если заголовок отличается от эталонного - сообщение-запрос считается неправильным и не должно обрабатываться.  
Если контрольная сумма в сообщении не совпадает с подсчитанной вами - сообщение-запрос считается неправильным и не должно обрабатываться.

Ответ микроконтроллера на правильное сообщение-запрос должен выглядеть следующим образом:

| 1 байт | 2 байт | 3 байт | 4 байт   |
| ------ | ------ | ------ | -------- |
| 0xAA   | 0xCC   | count  | checksum |

Здесь:
- первые два байта - неизменный заголовок ответа
- count - счетчик, который соответствует количеству полученных *правильных* запросов
- checksum - контрольная сумма, вычисляемая аналогично

Динамик подключен к выводу РА4, генерировать звук можно любым способом, форма сигнала может быть любой (периодической).
Используется UART2 на выводах РА2, РА3, бодрейт - 57600 бод.  
Допустимое отклонение частоты звука от заданной - 5%.

**Подвохи**:
- сообщения могут приходить очень часто, в том числе без пауз
- частота звука может быть любой, от 0 до 65535 Гц
- из-за помех на линии сообщения *не всегда* приходят целиком


Подумайте, будет ли в вашей программе обмен сообщениями влиять на генерируемый звук? Например, если в запросах всегда указана одинаковая частота, будет ли звук меняться? Если да - то почему? Как можно избавиться от этого эффекта?

**Ваши соображения приведите в отчете**.

# Как проверять это задание на симуляторе?

Для отладки вашей программы на симуляторе пользуйтесь виртуальным осциллографом (чтобы проверять частоту звука) и виртуальным окном UART - его можно открыть в режиме отладки через View -> Serial windows -> USARTx.  
Вы можете печатать в этом окне (но символы не будут отображаться), каждый набранный символ будет послан по UART в кодировке ASCII. В меню по правому клику на этом окне вы можете выбрать режим отображения байтов, которые отправляет контроллер.

Для отправки микроконтроллеру отдельных байтов можно использовать виртуальные регистры `sxin`, где х - номер UART'a.

Например, для того, чтобы послать по UART1 байт в шестнадцатиричном коде, в окне command window наберите `s1in= 0xAA`, нажмите Enter - и число 0xAA будет отправлено по UART1.  
Аналогично можно послать десятичное число: `s1in = 5` или один символ в кодировке ASCII: `s1in = 'U'`

В какой-то момент вам может стать лень руками, по одному байту за раз, набирать запросы для второй части и считать контрольную сумму на калькуляторе. В таком случае вы можете воспользоваться *скриптами для симулятора*.

Эти скрипты пишутся на "С-подобном" языке и позволяют заставлять симулятор выполнять некий набор действий, в том числе, отправлять несколько байт в UART или считать контрольную сумму.

Подробнее о написании таких скриптов:  
http://www.keil.com/support/man/docs/uv4/uv4_sm_uartcommunication.htm  
http://www.keil.com/support/man/docs/uv4/uv4_swatch.htm

Отличия между языком С и "С-подобным языком" для скриптов:  
http://www.keil.com/support/man/docs/uv4/uv4_df_diffbtwdbgandc.htm  
Вкратце: 
 - препроцессора нет
 - регистр букв не имеет значения
 - все переменные создаем в начале функции
 - нельзя совмещать создание и присвоение
 - глобальных переменных нет
 - если функция трогает виртуальные регистры - то она должна быть помечена как signal

# Задания на дополнительные баллы:

- реализуйте обмен по UART'у во второй части с помощью прерываний (без поллинга флагов): + 1 балл
- расположите внутри прерывания только прием и передачу байтов, не помещайте туда всю логику разбора сообщений: +1 балл
- во второй части используйте вместо контрольной суммы CRC8 со следующими параметрами:

```
Poly  : 0x31    x^8 + x^5 + x^4 + 1
Init  : 0xFF
Revert: false
XorOut: 0x00
Check : 0xF7 ("123456789") 
```

В отчете поясните, в чем разница между простой контрольной суммой и CRC, опишите их плюсы и минусы: +2 балла



